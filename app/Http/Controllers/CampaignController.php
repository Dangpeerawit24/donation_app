<?php

namespace App\Http\Controllers;

use App\Models\Campaign;
use Illuminate\Support\Facades\DB;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Auth;

class CampaignController extends Controller
{
    public function index()
    {
        $categories = DB::table('categories')->get();
        $Results = DB::table('campaigns')
            ->leftJoin(
                DB::raw('(SELECT campaignsid, SUM(value) as total_value 
                  FROM campaign_transactions 
                  GROUP BY campaignsid) as ct'),
                'campaigns.id',
                '=',
                'ct.campaignsid'
            )
            ->select('campaigns.*', DB::raw('IFNULL(ct.total_value, 0) as total_value'))
            ->orderByDesc('campaigns.created_at')
            ->get();

        if (Auth::user()->type === 'admin') {
            return view('admin.campaigns', compact('categories', 'Results'));
        } elseif (Auth::user()->type === 'manager') {
            return view('manager.campaigns', compact('categories', 'Results'));
        }
    }

    public function store(Request $request)
    {
        $request->validate([
            'categoriesID' => 'required|integer',
            'name' => 'required',
            'description' => 'required',
            'price' => 'required|numeric',
            'stock' => 'required|integer',
            'details' => 'required',
            'status' => 'required',
            'respond' => 'required',
            'campaign_img' => 'nullable|image|mimes:jpeg,png,jpg,gif|max:7048',
        ]);

        $data = $request->all();

        // р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Фр╕гр╕╣р╕Ыр╕ар╕▓р╕Ю
        if ($request->hasFile('campaign_img')) {
            $fileName = time() . '.' . $request->campaign_img->extension();
            $request->campaign_img->move(public_path('img/campaign/'), $fileName);
            $data['campaign_img'] = $fileName;
        }

        // р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕е
        $campaign = Campaign::create($data);

        if ($campaign->status == "р╣Ар╕Ыр╕┤р╕Фр╕Бр╕нр╕Зр╕Ър╕╕р╕Н") {
            // р╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б Broadcast
            $lineToken = env('LINE_CHANNEL_ACCESS_TOKEN');
            $linkapp = env('APP_URL');
            $priceMessage = ($campaign->price == 1) ? "р╕Хр╕▓р╕бр╕Бр╕│р╕ер╕▒р╕Зр╕ир╕гр╕▒р╕Чр╕Шр╕▓" : "{$campaign->price} р╕Ър╕▓р╕Ч";
            // р╕кр╕гр╣Йр╕▓р╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕кр╕│р╕лр╕гр╕▒р╕Ър╕кр╣Ир╕З
            $message = "ЁЯОЙ р╕Вр╕нр╣Ар╕Кр╕┤р╕Нр╕гр╣Ир╕зр╕бр╕Бр╕нр╕Зр╕Ър╕╕р╕Н ЁЯОЙ\n" .
                "тЬи {$campaign->name}\n" .
                "ЁЯТ░ р╕гр╣Ир╕зр╕бр╕Ър╕╕р╕Н: {$priceMessage}\n" .
                "ЁЯУЛ " . $campaign->description;
            // "ЁЯУЛ " . str_replace(",", "\n", $campaign->description);

            $message2 = "р╣Бр╕кр╕Фр╕Зр╕лр╕ер╕▒р╕Бр╕Рр╕▓р╕Щр╕Бр╕▓р╕гр╕гр╣Ир╕зр╕бр╕Ър╕╕р╕Н\n" .
                "ЁЯТ░ р╕бр╕╣р╕ер╕Щр╕┤р╕Шр╕┤р╣Ар╕бр╕Хр╕Хр╕▓р╕Шр╕гр╕гр╕бр╕гр╕▒р╕ир╕бр╕╡\n" .
                "р╕Ш.р╕Бр╕кр╕┤р╕Бр╕гр╣Др╕Чр╕в р╣Ар╕ер╕Вр╕Чр╕╡р╣Ир╕Ър╕▒р╕Нр╕Кр╕╡ 171-1-75423-3\n" .
                "р╕Ш.р╣Др╕Чр╕вр╕Юр╕▓р╕Ур╕┤р╕Кр╕вр╣М р╣Ар╕ер╕Вр╕Чр╕╡р╣Ир╕Ър╕▒р╕Нр╕Кр╕╡ 649-242269-4\n\n" .
                "ЁЯУМ р╕гр╣Ир╕зр╕бр╕Ър╕╕р╕Нр╕Ьр╣Ир╕▓р╕Щр╕гр╕░р╕Ър╕Ър╕Бр╕нр╕Зр╕Ър╕╕р╕Нр╕нр╕нр╕Щр╣Др╕ер╕Щр╣Мр╣Др╕Фр╣Йр╕Чр╕╡р╣И : https://liff.line.me/2006463554-1M9q5zzK";

            // $imageUrl = asset('img/campaign/' . $campaign->campaign_img);
            $imageUrl = "https://images.unsplash.com/photo-1720048169707-a32d6dfca0b3?w=700&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDF8MHxmZWF0dXJlZC1waG90b3MtZmVlZHwxfHx8ZW58MHx8fHx8"; 

            // р╕кр╣Ир╕Зр╕Др╕│р╕Вр╕нр╣Др╕Ыр╕вр╕▒р╕З LINE OA
            $response = Http::withHeaders([
                'Content-Type' => 'application/json',
                'Authorization' => "Bearer $lineToken",
            ])->post('https://api.line.me/v2/bot/message/broadcast', [
                'messages' => [
                    [
                        'type' => 'image',
                        'originalContentUrl' => $imageUrl, // р╕гр╕╣р╕Ыр╕ар╕▓р╕Ю
                        'previewImageUrl' => $imageUrl, // р╕гр╕╣р╕Ыр╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕З
                    ],
                    [
                        'type' => 'text',
                        'text' => $message, // р╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б
                    ],
                    [
                        'type' => 'text',
                        'text' => $message2, // р╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б
                    ],
                ],
            ]);

            // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕▓р╕гр╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б Broadcast
            if ($response->successful()) {
                return redirect()->back()->with('success', 'р╣Ар╕Юр╕┤р╣Ир╕бр╕Бр╕нр╕Зр╕Ър╕╕р╕Нр╣Бр╕ер╕░р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б Broadcast р╕Юр╕гр╣Йр╕нр╕бр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕вр╣Бр╕ер╣Йр╕з.');
            } else {
                return redirect()->back()->with('success', 'р╣Ар╕Юр╕┤р╣Ир╕бр╕Бр╕нр╕Зр╕Ър╕╕р╕Нр╕кр╕│р╣Ар╕гр╣Зр╕И р╣Бр╕Хр╣Ир╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б Broadcast р╣Др╕бр╣Ир╕кр╕│р╣Ар╕гр╣Зр╕И.');
            }
        } else {
            return redirect()->back()->with('success', 'р╣Ар╕Юр╕┤р╣Ир╕бр╕Бр╕нр╕Зр╕Ър╕╕р╕Нр╕кр╕│р╣Ар╕гр╣Зр╕И');
        }
    }

    public function update(Request $request, $id)
    {
        $validated = $request->validate([
            'categoriesID' => 'required|integer',
            'name' => 'required',
            'description' => 'required',
            'price' => 'required|numeric',
            'stock' => 'required|integer',
            'details' => 'required',
            'status' => 'required',
            'campaign_img' => 'nullable|image|mimes:jpeg,png,jpg,gif|max:7048',
        ]);

        $Campaign = Campaign::findOrFail($id);

        $Campaign->update([
            'name' => $validated['name'],
            'price' => $validated['price'],
            'description' => $validated['description'],
            'stock' => $validated['stock'],
            'details' => $validated['details'],
            'status' => $validated['status'] ?? null,
        ]);

        // р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Фр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╕Цр╣Йр╕▓р╕бр╕╡
        if ($request->hasFile('campaign_img')) {
            // р╕ер╕Ър╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╣Ар╕Бр╣Ир╕▓ (р╕Цр╣Йр╕▓р╕бр╕╡)
            if ($Campaign->campaign_img && file_exists(public_path('img/campaign/' . $Campaign->campaign_img))) {
                unlink(public_path('img/campaign/' . $Campaign->campaign_img));
            }

            // р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Фр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╣Гр╕лр╕бр╣И
            $fileName = time() . '.' . $request->campaign_img->extension();
            $request->campaign_img->move(public_path('img/campaign/'), $fileName);

            // р╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╣Гр╕Щр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е
            $Campaign->update(['campaign_img' => $fileName]);
        }

        return redirect()->back()->with('success', 'р╣Бр╕Бр╣Йр╣Др╕Вр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Бр╕нр╕Зр╕Ър╕╕р╕Н р╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕вр╣Бр╕ер╣Йр╕з.');
    }

    public function Closed($id)
    {
        $campaign = Campaign::findOrFail($id);

        $campaign->update([
            'status' => "р╕Ыр╕┤р╕Фр╕Бр╕нр╕Зр╕Ър╕╕р╕Нр╣Бр╕ер╣Йр╕з"
        ]);

        // Push р╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╣Др╕Ыр╕вр╕▒р╕З LINE OA р╕Бр╣Ир╕нр╕Щр╕Чр╕│р╕Бр╕▓р╕гр╕ер╕Ъ
        $lineToken = env('LINE_CHANNEL_ACCESS_TOKEN'); // LINE Access Token
        $message = "ЁЯЩП р╕Вр╕нр╕нр╕Щр╕╕р╕Нр╕▓р╕Хр╕Ыр╕┤р╕Фр╕Бр╕нр╕Зр╕Ър╕╕р╕Нр╕Др╕гр╕▒р╕Ъ ЁЯЩП\n" .
            "ЁЯЩП р╕Вр╕нр╕нр╕Щр╕╕р╕Нр╕▓р╕Хр╕Ыр╕┤р╕Фр╕Бр╕нр╕Зр╕Ър╕╕р╕Нр╕Др╕гр╕▒р╕Ъ ЁЯЩП\n\n" .
            "р╕Бр╕нр╕Зр╕Ър╕╕р╕Н : {$campaign->name}\n\n" .
            "р╕Вр╕нр╕нр╕▓р╕Щр╕┤р╕кр╕Зр╕кр╣Мр╣Бр╕лр╣Ир╕Зр╕Ър╕╕р╕Нр╕Щр╕╡р╣Йр╕кр╣Ир╕Зр╕Ьр╕ер╣Гр╕лр╣Йр╕Чр╕╕р╕Бр╕Чр╣Ир╕▓р╕Щр╕бр╕╡р╕Кр╕╡р╕зр╕┤р╕Хр╕Чр╕╡р╣Ир╕кр╕зр╣Ир╕▓р╕Зр╣Др╕кр╕з р╣Ар╕Ир╕гр╕┤р╕Нр╕гр╕╕р╣Ир╕Зр╣Ар╕гр╕╖р╕нр╕З р╕кр╕бр╕Ыр╕гр╕▓р╕гр╕Цр╕Щр╕▓р╣Гр╕Щр╕кр╕┤р╣Ир╕Зр╕Чр╕╡р╣Ир╕Хр╕▒р╣Йр╕Зр╣Гр╕Ир╕Чр╕╕р╕Бр╕Ыр╕гр╕░р╕Бр╕▓р╕г";

        // р╕кр╣Ир╕Зр╕Др╕│р╕Вр╕нр╣Др╕Ыр╕вр╕▒р╕З LINE API
        $response = Http::withHeaders([
            'Content-Type' => 'application/json',
            'Authorization' => "Bearer $lineToken",
        ])->post('https://api.line.me/v2/bot/message/broadcast', [
            'messages' => [
                [
                    'type' => 'text',
                    'text' => $message, // р╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╕кр╣Ир╕З
                ],
            ],
        ]);

        if (!$response->successful()) {
            return redirect()->back()->with('error', 'р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щр╣Др╕Фр╣Й.');
        }

        return response()->json(['success' => true, 'message' => 'р╕Ыр╕┤р╕Фр╕Бр╕нр╕Зр╕Ър╕╕р╕Нр╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕вр╣Бр╕ер╣Йр╕з.']);
    }

    public function pushmessage(Request $request)
    {
        $campaign_id = $request->query('campaign_id');
        if (!$campaign_id) {
            return redirect()->back()->with('error', 'р╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕бр╣Ир╕Др╕гр╕Ър╕Цр╣Йр╕зр╕Щ');
        }

        // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕бр╕╡ campaign р╕Щр╕╡р╣Йр╕нр╕вр╕╣р╣Ир╣Гр╕Щр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е
        $campaign = DB::table('campaigns')->where('id', $campaign_id)->first();
        if (!$campaign) {
            return redirect()->back()->with('error', 'р╣Др╕бр╣Ир╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Бр╕нр╕Зр╕Ър╕╕р╕Н');
        }

        // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕╡р╣Ир╕кр╣Ир╕Зр╕бр╕▓
        $validated = $request->validate([
            'textareaInput' => 'required',
            'campaign_imgpush' => 'nullable|image|mimes:jpeg,png,jpg,gif|max:7048',
        ]);

        // р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Фр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╣Бр╕ер╕░р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╣Гр╕Щр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е
        $fileName = null;
        if ($request->hasFile('campaign_imgpush')) {
            $fileName = time() . '.' . $request->campaign_imgpush->extension();
            $request->campaign_imgpush->move(public_path('img/campaignpush/'), $fileName);

            // р╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╣Гр╕Щр╕Хр╕▓р╕гр╕▓р╕З campaigns
            DB::table('campaigns')->where('id', $campaign_id)->update([
                'campaign_imgpush' => $fileName,
            ]);
        }

        // р╣Ар╕Хр╕гр╕╡р╕вр╕бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕кр╕│р╕лр╕гр╕▒р╕Ър╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б Broadcast
        $priceMessage = $campaign->price == 1 ? 'р╕Хр╕▓р╕бр╕Бр╕│р╕ер╕▒р╕Зр╕ир╕гр╕▒р╕Чр╕Шр╕▓' : number_format($campaign->price, 2) . ' р╕Ър╕▓р╕Ч';
        $description = $validated['textareaInput'] ?? '';

        $message = "{$description}\n" .
            "тЬи р╕Бр╕нр╕Зр╕Ър╕╕р╕Н{$campaign->name}\n" .
            "ЁЯТ░ р╕гр╣Ир╕зр╕бр╕Ър╕╕р╕Н: {$priceMessage}\n\n" .
            "р╣Бр╕кр╕Фр╕Зр╕лр╕ер╕▒р╕Бр╕Рр╕▓р╕Щр╕Бр╕▓р╕гр╕гр╣Ир╕зр╕бр╕Ър╕╕р╕Н\n" .
            "ЁЯТ░ р╕бр╕╣р╕ер╕Щр╕┤р╕Шр╕┤р╣Ар╕бр╕Хр╕Хр╕▓р╕Шр╕гр╕гр╕бр╕гр╕▒р╕ир╕бр╕╡\n" .
            "р╕Ш.р╕Бр╕кр╕┤р╕Бр╕гр╣Др╕Чр╕в р╣Ар╕ер╕Вр╕Чр╕╡р╣Ир╕Ър╕▒р╕Нр╕Кр╕╡ 171-1-75423-3\n" .
            "р╕Ш.р╣Др╕Чр╕вр╕Юр╕▓р╕Ур╕┤р╕Кр╕вр╣М р╣Ар╕ер╕Вр╕Чр╕╡р╣Ир╕Ър╕▒р╕Нр╕Кр╕╡ 649-242269-4\n\n" .
            "ЁЯУМ р╕гр╣Ир╕зр╕бр╕Ър╕╕р╕Нр╕Ьр╣Ир╕▓р╕Щр╕гр╕░р╕Ър╕Ър╕Бр╕нр╕Зр╕Ър╕╕р╕Нр╕нр╕нр╕Щр╣Др╕ер╕Щр╣Мр╣Др╕Фр╣Йр╕Чр╕╡р╣И : https://liff.line.me/2006463554-1M9q5zzK";

        // $imageUrl = $fileName
        //     ? asset('img/campaignpush/' . $fileName)
        //     : asset('img/campaign/' . $campaign->campaign_img);

        $imageUrl = "https://images.unsplash.com/photo-1720048169707-a32d6dfca0b3?w=700&auto=format&fit=crop&q=60&ixlib=rb-4.0.3&ixid=M3wxMjA3fDF8MHxmZWF0dXJlZC1waG90b3MtZmVlZHwxfHx8ZW58MHx8fHx8"; 

        // р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б Broadcast р╕Ьр╣Ир╕▓р╕Щ LINE API
        $lineToken = env('LINE_CHANNEL_ACCESS_TOKEN');
        $response = Http::withHeaders([
            'Content-Type' => 'application/json',
            'Authorization' => "Bearer $lineToken",
        ])->post('https://api.line.me/v2/bot/message/broadcast', [
            'messages' => [
                [
                    'type' => 'image',
                    'originalContentUrl' => $imageUrl,
                    'previewImageUrl' => $imageUrl,
                ],
                [
                    'type' => 'text',
                    'text' => $message,
                ],
            ],
        ]);

        // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╕Вр╕нр╕Зр╕Бр╕▓р╕гр╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б
        if ($response->successful()) {
            return redirect()->back()->with('success', 'pushmessage р╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕вр╣Бр╕ер╣Йр╕з.');
        } else {
            return redirect()->back()->with('error', 'pushmessage р╣Др╕бр╣Ир╕кр╕│р╣Ар╕гр╣Зр╕И.');
        }
    }



    public function destroy($id)
    {
        $campaign = Campaign::findOrFail($id);

        // р╕ер╕Ър╣Др╕Яр╕ер╣Мр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╕лр╕▓р╕Бр╕бр╕╡р╕нр╕вр╕╣р╣И
        if ($campaign->campaign_img && file_exists(public_path('img/campaign/' . $campaign->campaign_img))) {
            unlink(public_path('img/campaign/' . $campaign->campaign_img));
        }

        // р╕ер╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Гр╕Щр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е
        $campaign->delete();

        return redirect()->back()->with('success', 'р╕ер╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Бр╕нр╕Зр╕Ър╕╕р╕Нр╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕вр╣Бр╕ер╣Йр╕з.');
    }
}
